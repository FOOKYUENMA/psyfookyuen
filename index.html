<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>塞可乐鸡树洞 | Psychology Tree Hole</title>
    <script src="https://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
</head>
<body>
    <header>
        <h1>塞可乐鸡树洞</h1>
        <h2>Psychology Tree Hole</h2>
    </header>
    <main>
        <div id="login_container"></div>
        <script type="text/javascript">
            var obj = new WxLogin({
                self_redirect: true,
                id: "login_container",
                appid: "wx49015d02a87112cb",
                scope: "snsapi_login",
                redirect_uri: encodeURIComponent("https://psyfookyuen.com/callback"),
                state: "random_state",
                style: "",
                href: ""
            });
        </script>
        <div id="content">
            <!-- 登录成功后显示留言功能 -->
            <div class="text-display" id="textDisplay"></div>
            <div class="text-form">
                <input type="text" id="userText" maxlength="100" placeholder="输入你的内容 (最多100字)">
                <input type="submit" value="提交" onclick="addMessage()">
            </div>
        </div>
    </main>
    <footer>
        <p>联系方式: <a href="mailto:962362833@qq.com">962362833@qq.com</a></p>
        <p>© 2024 Psychology Tree Hole</p>
    </footer>
    <script>
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            databaseURL: "YOUR_FIREBASE_DATABASE_URL",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            firebase.auth().signInWithCustomToken(token)
                .then((userCredential) => {
                    console.log('用户已登录:', userCredential.user);
                    // 登录成功后显示留言
                    fetchMessages();
                })
                .catch((error) => {
                    console.error('登录过程中出错:', error);
                });
        }

        function addMessage() {
            const userText = document.getElementById('userText').value;
            if (userText) {
                const messageRef = firebase.database().ref('messages').push();
                messageRef.set({
                    text: userText
                });
                document.getElementById('userText').value = ''; // 清空输入框
                fetchMessages(); // 重新加载留言
            }
        }

        function fetchMessages() {
            const displayArea = document.getElementById('textDisplay');
            displayArea.innerHTML = ''; // 清空显示区域

            firebase.database().ref('messages').on('child_added', (snapshot) => {
                const message = snapshot.val();
                const p = document.createElement('p');
                p.textContent = message.text;
                displayArea.prepend(p);
            });
        }
    </script>
</body>
</html>
